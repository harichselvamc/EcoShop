{% extends "base.html" %}

{% block title %}AI Chat - EcoShop{% endblock %}

{% block content %}
<!-- AI Chatbot Page -->
<div class="container mt-5">
    <h2 class="text-center">AI Chat - Recycling Ideas</h2>
    <p class="text-center mb-4">Tell us what you have, and we'll suggest creative recycling ideas!</p>

    <!-- Chat Interface -->
    <div class="card">
        <div class="card-body">
            <div id="chat-container" class="d-flex flex-column" style="height: 400px; overflow-y: scroll;">
                <!-- Messages will appear here -->
            </div>

            <div class="mt-3">
                <input type="text" id="user-input" class="form-control" placeholder="Type your item (e.g., 3 plastic bottles)" />
                <button id="send-btn" class="btn btn-primary mt-3 w-100">Send</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript to handle chat interaction -->
<script>
    document.getElementById('send-btn').addEventListener('click', function() {
        const userInput = document.getElementById('user-input').value.trim();

        if (!userInput) {
            alert("Please enter an item for recycling.");
            return;
        }

        // Display user's message in chat container
        const chatContainer = document.getElementById('chat-container');
        chatContainer.innerHTML += `<div class="d-flex justify-content-end mb-2">
                                        <div class="bg-primary text-white p-2 rounded-3 max-w-75" style="max-width: 70%;"><strong>You:</strong> ${userInput}</div>
                                      </div>`;
        document.getElementById('user-input').value = ''; // Clear input field
        chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll to the bottom

        // Send request to the Flask backend (POST to /ai_chat)
        fetch('/ai_chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ user_input: userInput }),
        })
        .then(response => response.json())
        .then(data => {
            let botResponse = data.response || "Sorry, I couldn't come up with an idea at the moment.";
            
            // Render response with line breaks for better formatting
            botResponse = botResponse.replace(/\n/g, '<br>');  // Replace line breaks for HTML rendering

            // Display AI response in chat container
            chatContainer.innerHTML += `<div class="d-flex justify-content-start mb-2">
                                            <div class="bg-light text-dark p-2 rounded-3 max-w-75" style="max-width: 70%;"><strong>AI:</strong><br>${botResponse}</div>
                                          </div>`;
            chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll to the bottom
        })
        .catch(error => {
            console.error("Error:", error);
            chatContainer.innerHTML += `<div class="d-flex justify-content-start mb-2">
                                            <div class="bg-light text-dark p-2 rounded-3 max-w-75" style="max-width: 70%;"><strong>AI:</strong> An error occurred while generating the idea.</div>
                                          </div>`;
            chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll to the bottom
        });
    });

    // Allow pressing 'Enter' key to submit input
    document.getElementById('user-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('send-btn').click();
        }
    });
</script>

{% endblock %}
